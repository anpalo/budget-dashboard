<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Budget Dashboard Placeholder</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js" integrity="sha512-JPcRR8yFa8mmCsfrw4TNte1ZvF1e3+1SdGMslZvmrzDYxS69J7J49vkFL8u6u8PlPJK+H3voElBtUCzaXj+6ig==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Saira:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">  

</head>

<body>
<div id="sidebar-container"></div>
<div class="dashboard-grid">
<div class="topBanner"><h1>B</h1></div>
  <div class="totalSavings" id="totalSavingsWidget">
<h2 class="widget-title">Total Savings</h2>
<div class="amount-wrapper">
  <div class="amount-krw">--원</div>
  <div class="amount-usd">-- USD</div>
</div>
</div>
<div class="cyclePie">
  <canvas id="widgetPie"></canvas>
</div>
<div class="monthBar" style="position: relative;">
  <canvas id="widgetBar"></canvas>
</div>
<div class="mainPie">
  <div id="monthList">
    <span data-month="Jan" class="active">Jan</span>
    <span data-month="Feb">Feb</span>
    <span data-month="Mar">Mar</span>
    <span data-month="Apr">Apr</span>
    <span data-month="May">May</span>
    <span data-month="Jun">Jun</span>
    <span data-month="Jul">Jul</span>
    <span data-month="Aug">Aug</span>
    <span data-month="Sep">Sep</span>
    <span data-month="Oct">Oct</span>
    <span data-month="Nov">Nov</span>
    <span data-month="Dec">Dec</span>
  </div>
  <canvas id="pieChart"></canvas>
</div>
<div class="stockWidget">
<!-- Company Name Top-Left -->
<div id="stockHeader">
  <img id="stockLogo" src="/placeholder.png">
</div>

<div id="stockName"></div>

<!-- Price + Change Top-Right -->
<div id="stockStats"></div>

<!-- Chart Canvas -->
<canvas id="stockChart"></canvas>
</div>

</div>




<script src="sidebar.js"></script>



<script>
const dates = ["2025-09-11","2025-09-12","2025-09-13","2025-09-14","2025-09-15","2025-09-16","2025-09-17","2025-09-18","2025-09-19","2025-09-20","2025-09-21"];

const stockData = {
LULU: [305, 302, 295, 304, 290, 362, 325, 339, 300, 276, 239],
KO:   [62, 61, 63, 64, 62, 65, 66, 64, 63, 62, 70],
AAL:  [22, 21, 19, 18, 20, 21, 22, 20, 19, 18, 17]
};

const companyNames = {
LULU: "Lululemon",
KO: "Coca-Cola",
AAL: "American Airlines"
};

const symbols = Object.keys(stockData);
let stockIndex = 0;

const ctx = document.getElementById("stockChart").getContext("2d");
const chart = new Chart(ctx, {
type: "line",
data: { labels: dates, datasets: [] },
options: {
  responsive: true,
  plugins: { legend: { display: false } },
  layout: {
  padding: { top: 40, bottom: 20, left: 0, right: 10 }
},
  scales: {
    x: { title: { display: true, text: "Date", font: { family: "Saira", size: 16 } }, ticks: { font: { family: "Saira", size: 8 } } },
    y: { title: { display: true, text: "Price ($)", font: { family: "Saira", size: 16 } }, ticks: { font: { family: "Saira", size: 12 } } }
  }
}
});



function updateStockInfo(symbol, lastPrice, priceChange, percentChange) {
const color = priceChange >= 0 ? 'lightgreen' : '#f20c3e';
document.getElementById("stockName").innerText = companyNames[symbol];
document.getElementById("stockStats").innerHTML = `
  <span style="color:white;">${lastPrice.toFixed(2)} USD</span><br>
  <span style="color:${color};">${priceChange >= 0 ? '+' : '-'}${Math.abs(priceChange).toFixed(2)} (${percentChange.toFixed(2)}%) ${priceChange >= 0 ? '▲' : '▼'} past 10 days</span>
`;
}
function updateChart() {
const symbol = symbols[stockIndex];
const prices = stockData[symbol];
const firstPrice = prices[0];
const lastPrice = prices[prices.length - 1];
const priceChange = lastPrice - firstPrice;
const percentChange = (priceChange / firstPrice) * 100;

const lineColor = priceChange >= 0 ? 'lightgreen' : '#f20c3e';
const baseColor = priceChange >= 0 ? "144, 238, 144" : "242, 12, 62";

chart.data.datasets = [{
  label: `${symbol} Closing Price`,
  data: prices,
  borderColor: lineColor,
  fill: true,
  backgroundColor: (context) => {
    const chart = context.chart;
    const { ctx, chartArea } = chart;
    if (!chartArea) return `rgba(${baseColor}, 0.2)`;
    const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
    gradient.addColorStop(0, `rgba(${baseColor}, 0.3)`);
    gradient.addColorStop(0.5, `rgba(${baseColor}, 0.2)`);
    gradient.addColorStop(1, `rgba(${baseColor}, 0)`);
    return gradient;
  }
}];

chart.update();
updateStockInfo(symbol, lastPrice, priceChange, percentChange);

stockIndex = (stockIndex + 1) % symbols.length;
}

updateChart();


setInterval(updateChart, 7300);
</script>


<!-- 
<script>
const symbols = ["LULU", "KO", "AAL"];
const companyNames = {
  LULU: "Lululemon",
  KO: "Coca-Cola",
  AAL: "American Airlines"
};

const stockData = {};
const stockLogos = {};
let stockIndex = 0;

let fetchCount = 0;

async function fetchStock(symbol) {
  fetchCount++;
  console.log(`Fetching ${symbol} — call #${fetchCount}`);
  
  try {
    const res = await fetch(`/api/stocks?symbol=${symbol}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const dates = Object.keys(data).reverse();
    const prices = dates.map(date => parseFloat(data[date]["4. close"]));

    stockData[symbol] = { dates, prices };
  } catch (err) {
    console.error(`Error fetching data for ${symbol}:`, err);
  }
}

async function fetchLogo(symbol) {
  try {
    const res = await fetch(`/api/symbol-search?q=${symbol}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    return data.length > 0 && data[0].logo_url ? data[0].logo_url : "/placeholder.png";
  } catch (err) {
    console.error(`Error fetching logo for ${symbol}:`, err);
    return "/placeholder.png";
  }
}

const ctx = document.getElementById("stockChart").getContext("2d");
const chart = new Chart(ctx, {
  type: "line",
  data: { labels: [], datasets: [] },
  options: {
    responsive: true,
    plugins: { legend: { display: false } },
    layout: { padding: { top: 40, bottom: 20, left: 0, right: 10 } },
    scales: {
      x: { title: { display: true, text: "Date", font: { family: "Saira", size: 16 } }, ticks: { font: { family: "Saira", size: 8 } } },
      y: { title: { display: true, text: "Price ($)", font: { family: "Saira", size: 16 } }, ticks: { font: { family: "Saira", size: 12 } } }
    }
  }
});

function updateStockInfo(symbol) {
  const { dates, prices } = stockData[symbol];
  const firstPrice = prices[0];
  const lastPrice = prices[prices.length - 1];
  const priceChange = lastPrice - firstPrice;
  const percentChange = (priceChange / firstPrice) * 100;
  const isUp = priceChange >= 0;
  const color = isUp ? 'lightgreen' : '#f20c3e';
  const baseColor = isUp ? "144,238,144" : "242,12,62";

  document.getElementById("stockLogo").src = stockLogos[symbol];
  document.getElementById("stockName").innerText = companyNames[symbol];
  document.getElementById("stockStats").innerHTML = `
    <span style="color:white;">${lastPrice.toFixed(2)} USD</span><br>
    <span style="color:${color};">
      ${priceChange >= 0 ? '+' : '-'}${Math.abs(priceChange).toFixed(2)}
      (${percentChange.toFixed(2)}%)
      ${priceChange >= 0 ? '▲' : '▼'} past 10 days
    </span>
  `;

  chart.data.labels = dates;
  chart.data.datasets = [{
    label: `${symbol} Closing Price`,
    data: prices,
    borderColor: color,
    fill: true,
    backgroundColor: (context) => {
      const { ctx, chartArea } = context.chart;
      if (!chartArea) return `rgba(${baseColor},0.2)`;
      const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
      gradient.addColorStop(0, `rgba(${baseColor},0.3)`);
      gradient.addColorStop(0.5, `rgba(${baseColor},0.2)`);
      gradient.addColorStop(1, `rgba(${baseColor},0)`);
      return gradient;
    }
  }];
  chart.update();
}

function rotateStocks() {
  const symbol = symbols[stockIndex];
  updateStockInfo(symbol);
  stockIndex = (stockIndex + 1) % symbols.length;
}

(async () => {
  for (const s of symbols) {
    await fetchStock(s);
    stockLogos[s] = await fetchLogo(s);
  }
  rotateStocks();
  setInterval(rotateStocks, 7300);
})();
</script>


 -->


<script>
const importBtn = document.getElementById('importCsvBtn');
const csvInput = document.getElementById('csvInput');

importBtn.addEventListener('click', () => csvInput.click());

csvInput.addEventListener('change', async (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch('/api/upload-csv', {
      method: 'POST',
      body: formData
    });

    if (!res.ok) throw new Error('Upload failed');

    console.log('CSV uploaded successfully');
    
    // Refresh the dashboard after upload
    displayTotalSavings();
    fetch("/api/monthly-totals")
      .then(res => res.json())
      .then(data => {
        monthlyData = data;
        initPieChart(currentMonth);
        initCyclingPie(currentMonth);
      })
      .catch(err => console.error(err));

  } catch (err) {
    console.error(err);
    alert("Failed to upload CSV.");
  }
});
</script>



<script>
// get elements
const hamburger = document.getElementById('hamburger');
const sidebar = document.getElementById('sidebar');

// toggle sidebar on click
hamburger.addEventListener('click', () => {
sidebar.classList.toggle('open');
});
</script>




<script>
async function displayTotalSavings() {
  try {
      const res = await fetch("/api/total-savings");
      const data = await res.json();
      const krw = Number(data.krw);
      const usdRate = (await (await fetch("/api/currency")).json())["USD"] || 0;
      const usd = krw * usdRate;

      const widget = document.getElementById("totalSavingsWidget");
      widget.querySelector(".amount-krw").innerText = `${krw.toLocaleString('ko-KR')}원`;
      widget.querySelector(".amount-usd").innerText = `${usd.toLocaleString(undefined, {maximumFractionDigits: 2})} USD`;
  } catch (err) {
      console.error(err);
      document.getElementById("totalSavingsWidget").innerText = "Error loading savings.";
  }
}

displayTotalSavings();

</script>

<script>
let monthlyData = {};
let pieChart;
let cycleChart;
let cycleInterval;
let pieIndex = 0;
let currentMonth = "Jan";
const months = ["Jan","Feb","Mar","Apr","May","Jun"];
const monthNames = { "Jan": "January", "Feb": "February", "Mar": "March", "Apr": "April", "May": "May", "Jun": "June"};
const monthColorMap = {
Jan: { default: "#9D8AA6DE", hover: "#8100ba" },
Feb: { default: "#BAA4AEDE", hover: "#c9055a" },
Mar: { default: "#A0A695CC", hover: "#67c700cc" },
Apr: { default: "#8BA399CC", hover: "#008f53" },
May: { default: "#5C6B5ADE", hover: "#0a5e00" },
Jun: { default: "#C2BF919C", hover: "#d1c900" },
};



const categoryColorMap = {
"Bills": "#ff194d",
"Development": "#191cff",
"Gift/Grant": "#8605f2",
"Groceries": "#52FF88",
"Investment": "#ffe500",
"Meal/Socialization": "#ff21c7",
"Shopping": "#FF6F00",
"Vacation/Entertainment": "#00FFFF"
};


function highlightBarForMonth() {
if (!barChart) return;
const selectedIndex = months.indexOf(currentMonth);
 barChart.data.datasets[0].backgroundColor = months.map((m, i) =>
  i === selectedIndex ? monthColorMap[m].hover : monthColorMap[m].default
);

barChart.update();
}


fetch("/api/monthly-totals")
.then(res => res.json())
.then(data => {
  monthlyData = data;

  // compute totals per month
  const totalsPerMonth = months.map(m =>
    monthlyData[m].Totals.reduce((sum, e) => sum + e.Total, 0)
  );

  // --- Compute the diff of current month and last month ---
  const diff = totalsPerMonth[5] - totalsPerMonth[4];
  const diffColor = diff > 0 ? '#f20c3e' : 'limegreen';

  // create bar chart
  const ctxD = document.getElementById("widgetBar").getContext("2d");

  const topDiffLabel = {
    id: 'topDiffLabel',
    afterDraw(chart) {
      const { ctx, chartArea: { width } } = chart;
      ctx.save();
      ctx.fillStyle = "#ffffff";
      ctx.textBaseline = 'top';
      ctx.textAlign = 'left';

      const beforeText = "Spending ";
      const diffPart   = (diff > 0 ? "▲ ₩" : "▼ ") + Math.abs(diff).toLocaleString() + "원";
      const afterText  = ` in ${monthNames[months[months.length-1]]}`;

      const baseFont = '18px Saira';
      const boldFont = 'bold 24px Saira';

      ctx.font = baseFont;
      const beforeWidth = ctx.measureText(beforeText).width;
      const afterWidth  = ctx.measureText(afterText).width;
      ctx.font = boldFont;
      const diffWidth   = ctx.measureText(diffPart).width;

      const totalWidth = beforeWidth + diffWidth + afterWidth;
      let x = width / 2 - totalWidth / 2;
      const y = 24;

      ctx.font = baseFont;
      ctx.fillText(beforeText, x, y);
      x += beforeWidth;

      ctx.font = boldFont;
      ctx.fillText(diffPart, x, y);
      x += diffWidth;

      ctx.font = baseFont;
      ctx.fillText(afterText, x, y);

      ctx.restore();
    }
  };

  barChart = new Chart(ctxD, {
    type: 'bar',
    data: {
    labels: months,
    datasets: [{
      data: totalsPerMonth,
      backgroundColor: months.map((m, i) => i === 0 ? monthColorMap[m].hover : monthColorMap[m].default),
    hoverBackgroundColor: months.map(m => monthColorMap[m].hover),
      borderRadius: 4
    }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 20, bottom: 10, left: 10, right: 10 } },
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'center',
          align: 'center',
          color: '#FFFFFF',
          font: { weight: 'bold', size: 10 },
          formatter: value => "₩" + value.toLocaleString()
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: { beginAtZero: true, display: false, suggestedMax: Math.max(...totalsPerMonth) * 1.2 }
      }
    },
    plugins: [ChartDataLabels, topDiffLabel]
  });



  // bar clicks control pie chart
ctxD.canvas.onclick = function(evt) {
const points = barChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
if (points.length) {
  const idx = points[0].index;
  currentMonth = months[idx];

  // bild categories & totals in fixed order
  const categoryOrder = ["Bills","Development","Gift/Grant","Groceries", "Investment","Meal/Socialization","Shopping","Vacation/Entertainment"];
  const newCategories = categoryOrder.filter(cat =>
    monthlyData[currentMonth].Totals.some(e => e.Category === cat)
  );
  const newTotals = newCategories.map(cat =>
    monthlyData[currentMonth].Totals.find(e => e.Category === cat).Total
  );

  // update main pie
  pieChart.data.labels = newCategories;
  pieChart.data.datasets[0].data = newTotals;
  pieChart.data.datasets[0].backgroundColor = newCategories.map(cat => categoryColorMap[cat]);
  pieChart.update();

  // reset cycling pie
  resetCyclingPie();

  // update month titles
  const monthListSpans = document.querySelectorAll("#monthList span");
  monthListSpans.forEach(s => s.classList.remove("active"));
  const selected = document.querySelector(`#monthList span[data-month="${currentMonth}"]`);
  if (selected) selected.classList.add("active");

  // make selected bar glow
  highlightBarForMonth();
}
};


  // init pie charts after bar chart
  initPieChart(currentMonth);
  initCyclingPie(currentMonth);
  setupMonthClickHandlers();
})
.catch(err => console.error(err));

// PIE CHART FUNCS

function initPieChart(month) {
const categoryOrder = ["Bills","Development","Gift/Grant","Groceries", "Investment","Meal/Socialization","Shopping","Vacation/Entertainment"];

const newCategories = categoryOrder.filter(cat =>
  monthlyData[month].Totals.some(e => e.Category === cat)
);

const newTotals = newCategories.map(cat =>
  monthlyData[month].Totals.find(e => e.Category === cat).Total
);

const ctx = document.getElementById("pieChart").getContext("2d");
pieChart = new Chart(ctx, {
  type: "pie",
  data: { 
    labels: newCategories, 
    datasets: [{ 
      data: newTotals, 
      backgroundColor: newCategories.map(cat => categoryColorMap[cat]), 
      borderWidth: 2.5,
      borderColor: "#1b1c26",
    }] 
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    layout: { padding: { top: 20, bottom: 25, left: 10, right: 10 } },
    plugins: { legend: { display: true, position: "bottom", labels: { font: { size: 10 } } } }
  }
});
}

function setupMonthClickHandlers() {
const monthListSpans = document.querySelectorAll("#monthList span");

monthListSpans.forEach(span => {
  span.addEventListener("click", () => {
    // update active class
    monthListSpans.forEach(s => s.classList.remove("active"));
    span.classList.add("active");

    // set current month
    currentMonth = span.dataset.month;

    // build categories & totals in fixed order
    const categoryOrder = ["Bills","Development","Gift/Grant","Groceries", "Investment","Meal/Socialization","Shopping","Vacation/Entertainment"];

    const newCategories = categoryOrder.filter(cat =>
      monthlyData[currentMonth].Totals.some(e => e.Category === cat)
    );

    const newTotals = newCategories.map(cat =>
      monthlyData[currentMonth].Totals.find(e => e.Category === cat).Total
    );

    // update pie chart
    pieChart.data.labels = newCategories;
    pieChart.data.datasets[0].data = newTotals;
    pieChart.data.datasets[0].backgroundColor = newCategories.map(cat => categoryColorMap[cat]);
    pieChart.update();

    // reset cycling pie
    resetCyclingPie();

    // highlight selected bar
    highlightBarForMonth();
  });
});
}


function initCyclingPie(month) {
const categories = monthlyData[month].Totals.map(e => e.Category);
const totals = monthlyData[month].Totals.map(e => e.Total);
const totalSum = totals.reduce((a,b) => a+b, 0);
pieIndex = 0;

if(cycleChart) cycleChart.destroy();

const ctx = document.getElementById("widgetPie").getContext("2d");

const centerText = {
  id: 'centerText',
  afterDraw(chart) {
    const { ctx, chartArea:{width,height} } = chart;
    ctx.save();
    const cx = width/2+10, cy = height/2;
    ctx.textAlign = "center"; ctx.textBaseline="middle";

    //month name
    ctx.font = "bold 20px Saira";
    ctx.fillStyle = monthColorMap[currentMonth].hover;
    ctx.fillText(monthNames[currentMonth], cx-10, cy-50);

    //category name
    ctx.font = "bold 18px Saira"; ctx.fillStyle = "#FFFFFF";
    ctx.fillText(categories[pieIndex], cx-10, cy-20);

    //percentage
    ctx.font = "bold 24px Saira";
    const pct = ((totals[pieIndex]/totalSum)*100).toFixed(1);
    ctx.fillText(`${pct}%`, cx-5, cy+10);

    //amount
    ctx.font = "12px Saira"; ctx.fillStyle = categoryColorMap[categories[pieIndex]];
    ctx.fillText(`${totals[pieIndex].toLocaleString('ko-KR')}원`, cx-10, cy+40);
    ctx.restore();
  }
};

cycleChart = new Chart(ctx, {
  type: 'doughnut',
  data: { labels: [categories[0], "Other"], datasets: [{ data: [totals[0], totalSum-totals[0]],       
  backgroundColor: [categoryColorMap[categories[0]], "#2B2D30"],  
  borderWidth: 0 }] },
  options: { cutout: '90%', 
    responsive: true, 

  plugins: { legend: { display: false } } },
  plugins: [centerText]
});

cycleInterval = setInterval(() => {
  pieIndex = (pieIndex + 1) % categories.length;
  const currentCategory = categories[pieIndex]
  cycleChart.data.labels = [currentCategory, "Other"];
  cycleChart.data.datasets[0].data = [totals[pieIndex], totalSum - totals[pieIndex]];
  cycleChart.data.datasets[0].backgroundColor = [categoryColorMap[currentCategory], "#2B2D30"];
  cycleChart.update();
}, 5200);
}

function resetCyclingPie() {
clearInterval(cycleInterval);
initCyclingPie(currentMonth);
}
</script>
</body>
</html>
